<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard List - UpFile System</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <header class="dashboard-header">
        <div class="brand-section">
            <div class="brand-logo">üöÄ UpFile <span style="font-size:0.8rem; opacity:0.7;">(List View)</span></div>
            <a href="assign.html" id="btnAssign" class="btn btn-primary btn-sm" style="display:none; box-shadow:none;">
                + Ph√¢n c√¥ng
            </a>
            <a href="index2.html" class="btn btn-secondary btn-sm" style="margin-left: 10px;">Giao di·ªán C√¢y</a>
        </div>

        <div class="stats-group">
            <div class="stat-pill" title="T·ªïng s·ªë m·ª•c c·∫ßn n·ªôp">
                <span>T·ªïng:</span>
                <span id="statTotal" class="stat-val bg-blue">0</span>
            </div>
            <div class="stat-pill" title="ƒê√£ ho√†n th√†nh">
                <span>ƒê√£ n·ªôp:</span>
                <span id="statDone" class="stat-val bg-green">0</span>
            </div>
            <div class="stat-pill" title="Ch∆∞a ho√†n th√†nh">
                <span>Ch∆∞a n·ªôp:</span>
                <span id="statPending" class="stat-val bg-red">0</span>
            </div>
        </div>

        <div class="user-section">
            <div class="user-info-text">
                <span class="user-name" id="displayUserName">ƒêang t·∫£i...</span>
                <span class="user-role-badge" id="displayUserRole">...</span>
            </div>
            <div class="user-avatar" id="userAvatar">U</div>
            <button onclick="logout()" class="btn-logout-icon" title="ƒêƒÉng xu·∫•t">‚èª</button>
        </div>
    </header>

    <main class="main-container">
        <div id="dashboardContent" class="accordion-wrapper">
            <div style="text-align: center; margin-top: 50px; color: #999;">
                <p>ƒêang t·∫£i d·ªØ li·ªáu h·ªì s∆°...</p>
                <div class="loading-spinner"></div>
            </div>
        </div>
    </main>

    <input type="file" id="globalFileInput" style="display: none;" onchange="handleFileSelected(this)">
    <input type="hidden" id="currentProfileID">

    <script src="script.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            loadDashboardData();
        });

        // --- GHI ƒê√à H√ÄM RENDER DASHBOARD ---
        function renderDashboard(data) {
            const { Profile, SchoolYear, Folder, Subject, Block, Object: ObjectList, DocType, User } = data;
            const currentUser = JSON.parse(localStorage.getItem('upfile_user'));
            const isAdmin = currentUser.Permissions === 'Admin';
            const container = document.getElementById('dashboardContent');
            
            container.innerHTML = ''; 

            // 1. Join D·ªØ li·ªáu
            let enrichedData = Profile.map(p => {
                if (!isAdmin && p.AccountUpdate != currentUser.UserID) return null;
                const folderObj = Folder.find(f => f.FolderID == p.FolderID);

                return {
                    ...p,
                    SchoolYearName: findName(SchoolYear, 'SchoolYearID', p.SchoolYearID, 'SchoolYearName'),
                    FolderName: findName(Folder, 'FolderID', p.FolderID, 'FolderName'),
                    SubjectName: findName(Subject, 'SubjectID', p.SubjectID, 'SubjectName'),
                    BlockName: findName(Block, 'BlockID', p.BlockID, 'BlockName'),
                    ObjectName: findName(ObjectList, 'ObjectID', p.ObjectID, 'ObjectName'),
                    DocTypeName: findName(DocType, 'DocTypeID', p.DocTypeID, 'DocTypeName'),
                    UserName: findName(User, 'UserID', p.AccountUpdate, 'Name'),
                    isUploaded: p.FileID && p.FileID !== "",
                    Deadline: folderObj && folderObj.Deadline ? folderObj.Deadline : null
                };
            }).filter(item => item !== null);

            updateStats(enrichedData);

            // 2. Gom nh√≥m theo NƒÉm h·ªçc
            const yearGroups = groupBy(enrichedData, 'SchoolYearName');
            
            if (Object.keys(yearGroups).length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:50px;">Kh√¥ng c√≥ d·ªØ li·ªáu.</div>';
                return;
            }

            for (const [year, yearItems] of Object.entries(yearGroups)) {
                const lv1 = createAccordion(year, 'NƒÉm h·ªçc', 1);
                const lv1Content = lv1.querySelector('.level-content');

                // 3. Gom nh√≥m theo K·ª≥ ki·ªÉm tra
                const folderGroups = groupBy(yearItems, 'FolderName');

                for (const [folder, folderItems] of Object.entries(folderGroups)) {
                    const lv2 = createAccordion(folder, 'K·ª≥', 2);
                    const lv2Content = lv2.querySelector('.level-content');
                    
                    // Render B·∫£ng tr·ª±c ti·∫øp
                    const tableHtml = renderTable(folderItems, isAdmin);
                    lv2Content.appendChild(tableHtml);
                    
                    lv1Content.appendChild(lv2);
                }
                container.appendChild(lv1);
            }
        }

        function renderTable(items, isAdmin) {
            const wrapper = document.createElement('div');
            wrapper.className = 'table-responsive';

            // 1. S·∫ÆP X·∫æP CHU·∫®N: M√¥n -> Kh·ªëi -> ƒê·ªëi t∆∞·ª£ng -> Lo·∫°i
            items.sort((a, b) => {
                const subDiff = a.SubjectName.localeCompare(b.SubjectName);
                if (subDiff !== 0) return subDiff;

                const blkDiff = a.BlockName.localeCompare(b.BlockName);
                if (blkDiff !== 0) return blkDiff;

                const objDiff = a.ObjectName.localeCompare(b.ObjectName);
                if (objDiff !== 0) return objDiff;

                return a.DocTypeID - b.DocTypeID;
            });

            // Header
            let tableHeader = `
                <thead>
                    <tr>
                        <th style="width: 40px;">#</th>
                        <th>M√¥n h·ªçc</th>
                        <th>Kh·ªëi</th>
                        <th>ƒê·ªëi t∆∞·ª£ng</th>
                        <th>N·ªôi dung h·ªì s∆°</th>
                        ${isAdmin ? '<th>Gi√°o vi√™n</th>' : ''}
                        <th>Tr·∫°ng th√°i</th>
                        <th style="width: 100px; text-align:right;">Thao t√°c</th>
                    </tr>
                </thead>
            `;

            let tableBody = '<tbody>';

            // Bi·∫øn t·∫°m ƒë·ªÉ ki·ªÉm tra tr√πng l·∫∑p
            let prevSubject = null;
            let prevBlock = null;
            let prevObject = null;

            items.forEach((item, index) => {
                // Logic Check ·∫®n/Hi·ªán d√≤ng tr√πng
                let showSubject = false;
                let showBlock = false;
                let showObject = false;

                if (item.SubjectName !== prevSubject) {
                    showSubject = true; showBlock = true; showObject = true;
                } else if (item.BlockName !== prevBlock) {
                    showBlock = true; showObject = true;
                } else if (item.ObjectName !== prevObject) {
                    showObject = true;
                }

                prevSubject = item.SubjectName;
                prevBlock = item.BlockName;
                prevObject = item.ObjectName;

                // Class ·∫©n cell
                const subCellClass = showSubject ? '' : 'cell-hidden';
                const subCellContent = showSubject ? `<span class="table-badge badge-subject">${item.SubjectName}</span>` : '';

                const blkCellClass = showBlock ? '' : 'cell-hidden';
                const blkCellContent = showBlock ? `<span class="table-badge badge-block">${item.BlockName}</span>` : '';

                const objCellClass = showObject ? '' : 'cell-hidden';
                const objCellContent = showObject ? `<span class="table-badge badge-object">${item.ObjectName}</span>` : '';

                // Deadline & Status
                let isExpired = false;
                if (item.Deadline) {
                    const deadlineDate = new Date(item.Deadline);
                    deadlineDate.setHours(23, 59, 59);
                    if (new Date() > deadlineDate) isExpired = true;
                }
                const isUploaded = item.isUploaded;

                let statusHtml = isUploaded 
                    ? `<span style="color:#00b09b;">‚úî ${formatDateTimeFull(item.TimeUpdate)}</span>`
                    : `<span style="color:#e74c3c;">‚è≥ Ch∆∞a n·ªôp</span>`;

                // Buttons Icon
                let actionBtns = '';
                const downloadBtn = isUploaded 
                    ? `<button class="btn-icon download" title="T·∫£i v·ªÅ" onclick="downloadFile('${item.FileID}', '${item.ProfileID}')">üì•</button>` 
                    : '';

                if (isAdmin) {
                    actionBtns += downloadBtn;
                    if (isUploaded) actionBtns += `<button class="btn-icon delete-file" title="X√≥a file" onclick="adminDeleteFile('${item.ProfileID}')">üóë</button>`;
                    actionBtns += `<button class="btn-icon delete-row" title="X√≥a d√≤ng" onclick="adminDeleteRow('${item.ProfileID}')">‚úï</button>`;
                } else {
                    if (isExpired) {
                        actionBtns = isUploaded 
                            ? `${downloadBtn} <span class="status-expired">üîí</span>` 
                            : `<span class="status-expired">H·∫øt h·∫°n</span>`;
                    } else {
                        if (isUploaded) {
                            actionBtns = `${downloadBtn} <button class="btn-icon edit" title="Thay th·∫ø" onclick="triggerDirectUpload('${item.ProfileID}')">‚úé</button>`;
                        } else {
                            actionBtns = `<button class="btn-icon upload" title="N·ªôp file" onclick="triggerDirectUpload('${item.ProfileID}')">üì§</button>`;
                        }
                    }
                }

                // Render D√≤ng
                tableBody += `
                    <tr>
                        <td style="text-align:center; color:#ccc;">${index + 1}</td>
                        <td class="${subCellClass}">${subCellContent}</td>
                        <td class="${blkCellClass}">${blkCellContent}</td>
                        <td class="${objCellClass}">${objCellContent}</td>
                        
                        <td>
                            <span>${item.DocTypeName}</span>
                            ${item.Note ? `<br><small class="text-muted">üìù ${item.Note}</small>` : ''}
                        </td>
                        
                        ${isAdmin ? `<td>üë§ ${item.UserName}</td>` : ''}
                        
                        <td style="font-size:0.85rem;">
                            ${statusHtml}
                            ${item.Deadline ? `<div class="text-muted" style="font-size:0.75rem;">H·∫°n: ${formatDate(item.Deadline)}</div>` : ''}
                        </td>
                        <td><div class="cell-actions">${actionBtns}</div></td>
                    </tr>
                `;
            });

            tableBody += '</tbody>';
            const table = document.createElement('table');
            table.className = 'data-table';
            table.innerHTML = tableHeader + tableBody;

            wrapper.appendChild(table);
            return wrapper;
        }
    </script>
</body>
</html>
