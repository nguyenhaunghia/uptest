<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard List - UpFile System</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .header-actions {
            display: flex;
            gap: 8px;
            margin-left: auto;
            margin-right: 15px;
            align-items: center;
        }
        
        .btn-header-report {
            padding: 4px 10px;
            font-size: 0.75rem;
            border-radius: 4px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            transition: 0.2s;
            white-space: nowrap;
        }
        .btn-header-report:hover {
            background: #f1f2f6;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn-header-report.blue { color: #4e54c8; border-color: #bbdefb; }
        .btn-header-report.green { color: #00b09b; border-color: #b2f5ea; }

        /* CSS Cho Th·ªëng K√™ C·∫•p Folder */
        .folder-stats-inline {
            display: flex;
            gap: 6px;
            margin-left: 15px;
            align-items: center;
        }
        .fs-badge {
            padding: 3px 8px;
            border-radius: 12px;
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .fs-total { background-color: #4e54c8; }   
        .fs-done { background-color: #00b09b; }    
        .fs-pending { background-color: #e74c3c; } 

        /* CSS Cho Ti√™u ƒê·ªÅ Ph√¢n V√πng (Ph·∫ßn 1, Ph·∫ßn 2) */
        .section-split-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #2c3e50;
            margin-top: 30px;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e0e6ed;
            display: flex;
            align-items: center;
            gap: 8px;
        }
    </style>
</head>
<body>

    <header class="dashboard-header">
        <div class="brand-section">
            <div class="brand-logo">üöÄ UpFile <span style="font-size:0.8rem; opacity:0.7;">(List View)</span></div>
            <a href="assign.html" id="btnAssign" class="btn btn-primary btn-sm" style="display:none; box-shadow:none;">Ph√¢n c√¥ng</a>
        </div>

        <div class="stats-group"></div>

        <div class="user-section">
            <div class="user-info-text">
                <span class="user-name" id="displayUserName">ƒêang t·∫£i...</span>
                <span class="user-role-badge" id="displayUserRole">...</span>
            </div>
            <div class="user-avatar" id="userAvatar">U</div>
            <button onclick="logout()" class="btn-logout-icon" title="ƒêƒÉng xu·∫•t">‚èª</button>
        </div>
    </header>

    <main class="main-container">
        <div id="dashboardContent" class="accordion-wrapper">
            <div style="text-align: center; margin-top: 50px; color: #999;">
                <p>ƒêang t·∫£i d·ªØ li·ªáu h·ªì s∆°...</p>
                <div class="loading-spinner"></div>
            </div>
        </div>
    </main>

    <input type="file" id="globalFileInput" style="display: none;" onchange="handleFileSelected(this)">
    <input type="hidden" id="currentProfileID">

    <script src="script.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            loadDashboardData();
        });

        // --- RENDER DASHBOARD ---
        function renderDashboard(data) {
            const { Profile, SchoolYear, Folder, Subject, Block, Object: ObjectList, DocType, User } = data;
            const currentUser = JSON.parse(localStorage.getItem('upfile_user'));
            const isAdmin = currentUser.Permissions === 'Admin';
            const container = document.getElementById('dashboardContent');
            
            container.innerHTML = ''; 

            let adminData = [];
            let myUploadData = [];
            let myPreviewData = [];

            // 1. Ph√¢n lo·∫°i d·ªØ li·ªáu
            Profile.forEach(p => {
                // X·ª≠ l√Ω chu·ªói AccountPreview ƒë·ªÅ ph√≤ng c√≥ kho·∫£ng tr·∫Øng (VD: "U01, U02")
                let previewList = p.AccountPreview ? p.AccountPreview.toString().split(',').map(s => s.trim()) : [];
                
                let isUploader = p.AccountUpdate == currentUser.UserID;
                let isPreviewer = previewList.includes(String(currentUser.UserID));
                let roleContext = isAdmin ? 'admin' : (isUploader ? 'uploader' : (isPreviewer ? 'previewer' : 'none'));

                if (roleContext === 'none') return; // Kh√¥ng c√≥ quy·ªÅn th√¨ b·ªè qua

                const folderObj = Folder.find(f => f.FolderID == p.FolderID);

                let item = {
                    ...p,
                    RoleContext: roleContext, 
                    SchoolYearName: findName(SchoolYear, 'SchoolYearID', p.SchoolYearID, 'SchoolYearName'),
                    FolderName: findName(Folder, 'FolderID', p.FolderID, 'FolderName'),
                    SubjectName: findName(Subject, 'SubjectID', p.SubjectID, 'SubjectName'),
                    BlockName: findName(Block, 'BlockID', p.BlockID, 'BlockName'),
                    ObjectName: findName(ObjectList, 'ObjectID', p.ObjectID, 'ObjectName'),
                    DocTypeName: findName(DocType, 'DocTypeID', p.DocTypeID, 'DocTypeName'),
                    UserName: findName(User, 'UserID', p.AccountUpdate, 'Name'),
                    AccountEmail: findName(User, 'UserID', p.AccountUpdate, 'Account'),
                    isUploaded: p.FileID && p.FileID !== "",
                    Deadline: folderObj && folderObj.Deadline ? folderObj.Deadline : null
                };

                // Ph√¢n nh√≥m
                if (isAdmin) {
                    adminData.push(item); // N·∫øu l√† Admin th√¨ l·∫•y h·∫øt
                } else {
                    if (isUploader) myUploadData.push(item);
                    // D√πng else if ƒë·ªÉ n·∫øu v·ª´a n·ªôp v·ª´a gi√°m s√°t th√¨ ∆∞u ti√™n hi·ªán ·ªü ph·∫ßn n·ªôp (n·∫øu b·∫°n mu·ªën hi·ªán ·ªü c·∫£ 2 ph·∫ßn th√¨ ƒë·ªïi th√†nh if)
                    else if (isPreviewer) myPreviewData.push(item); 
                }
            });

            // 2. Render Giao Di·ªán Theo Nh√≥m
            if (isAdmin) {
                if (adminData.length === 0) {
                    container.innerHTML = '<div style="text-align:center; padding:50px;">Kh√¥ng c√≥ d·ªØ li·ªáu.</div>';
                } else {
                    buildHierarchy('üëë TO√ÄN B·ªò H·ªí S∆† QU·∫¢N L√ù (QUY·ªÄN ADMIN)', adminData, container, true, true);
                }
            } else {
                if (myUploadData.length === 0 && myPreviewData.length === 0) {
                    container.innerHTML = '<div style="text-align:center; padding:50px;">B·∫°n ch∆∞a ƒë∆∞·ª£c ph√¢n c√¥ng nhi·ªám v·ª• n√†o.</div>';
                } else {
                    // PH·∫¶N 1: H·ªí S∆† PH·∫¢I N·ªòP (Kh√¥ng hi·ªán c·ªôt T√™n Gi√°o vi√™n)
                    if (myUploadData.length > 0) {
                        buildHierarchy('üì§ PH·∫¶N 1: H·ªí S∆† C√Å NH√ÇN', myUploadData, container, false, false);
                    }
                    
                    // PH·∫¶N 2: H·ªí S∆† GI√ÅM S√ÅT (Hi·ªán c·ªôt T√™n Gi√°o vi√™n)
                    if (myPreviewData.length > 0) {
                        buildHierarchy('üëÅÔ∏è PH·∫¶N 2: H·ªí S∆† T·ªî CHUY√äN M√îN', myPreviewData, container, false, true);
                    }
                }
            }
        }

        // --- H√ÄM T·∫†O C·∫§U TR√öC DANH S√ÅCH (D√ôNG CHUNG) ---
        function buildHierarchy(sectionTitle, items, container, isAdmin, showUserCol) {
            const headerTitle = document.createElement('div');
            headerTitle.className = 'section-split-title';
            headerTitle.innerHTML = sectionTitle;
            container.appendChild(headerTitle);

            const yearGroups = groupBy(items, 'SchoolYearName');

            for (const [year, yearItems] of Object.entries(yearGroups)) {
                const lv1 = createAccordion(year, 'NƒÉm h·ªçc', 1);
                const lv1Content = lv1.querySelector('.level-content');

                const folderGroups = groupBy(yearItems, 'FolderName');

                for (const [folder, folderItems] of Object.entries(folderGroups)) {
                    const lv2 = createAccordion(folder, 'K·ª≥', 2);
                    const lv2Header = lv2.querySelector('.level-header');
                    const lv2Content = lv2.querySelector('.level-content');
                    
                    // Th·ªëng k√™ c·∫•p Folder
                    const totalItems = folderItems.length;
                    const doneItems = folderItems.filter(item => item.isUploaded).length;
                    const pendingItems = totalItems - doneItems;

                    const statsDiv = document.createElement('div');
                    statsDiv.className = 'folder-stats-inline';
                    statsDiv.innerHTML = `
                        <span class="fs-badge fs-total">T·ªïng: ${totalItems}</span>
                        <span class="fs-badge fs-done">ƒê√£ n·ªôp: ${doneItems}</span>
                        <span class="fs-badge fs-pending">Ch∆∞a n·ªôp: ${pendingItems}</span>
                    `;

                    const arrow = lv2Header.querySelector('small');
                    if (arrow) lv2Header.insertBefore(statsDiv, arrow);
                    else lv2Header.appendChild(statsDiv);

                    // N√∫t b√°o c√°o cho Admin
                    if (isAdmin) {
                        const actionDiv = document.createElement('div');
                        actionDiv.className = 'header-actions';
                        
                        const btnAssignRep = document.createElement('button');
                        btnAssignRep.className = 'btn-header-report blue';
                        btnAssignRep.innerHTML = 'üì• T·ªïng h·ª£p ph√¢n c√¥ng';
                        btnAssignRep.onclick = (e) => { e.stopPropagation(); exportWord(folderItems, folder, 'ASSIGN'); };

                        const btnResultRep = document.createElement('button');
                        btnResultRep.className = 'btn-header-report green';
                        btnResultRep.innerHTML = 'üìä T·ªïng h·ª£p k·∫øt qu·∫£';
                        btnResultRep.onclick = (e) => { e.stopPropagation(); exportWord(folderItems, folder, 'RESULT'); };

                        actionDiv.appendChild(btnAssignRep);
                        actionDiv.appendChild(btnResultRep);
                        
                        if (arrow) lv2Header.insertBefore(actionDiv, arrow);
                        else lv2Header.appendChild(actionDiv);
                    }

                    // Render b·∫£ng v√† truy·ªÅn c·ªù showUserCol
                    const tableHtml = renderTable(folderItems, isAdmin, showUserCol);
                    lv2Content.appendChild(tableHtml);
                    lv1Content.appendChild(lv2);
                }
                container.appendChild(lv1);
            }
        }

        // --- H√ÄM XU·∫§T FILE WORD ---
        async function exportWord(items, folderName, type) {
            const isAgree = await sysConfirm(
                "X√°c nh·∫≠n t·∫£i b√°o c√°o",
                "B·∫°n mu·ªën t·∫£i file b√°o c√°o <b>" + (type === 'ASSIGN' ? 'Ph√¢n c√¥ng' : 'K·∫øt qu·∫£ n·ªôp') + "</b><br>cho k·ª≥: " + folderName + "?",
                "info"
            );
            if (!isAgree) return;

            items.sort((a, b) => {
                const subDiff = a.SubjectName.localeCompare(b.SubjectName);
                if (subDiff !== 0) return subDiff;
                const blkDiff = a.BlockName.localeCompare(b.BlockName);
                if (blkDiff !== 0) return blkDiff;
                const objDiff = a.ObjectName.localeCompare(b.ObjectName);
                if (objDiff !== 0) return objDiff;
                return a.DocTypeID - b.DocTypeID;
            });

            var part1 = '<' + 'html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40">';
            var part2 = '<' + 'head><' + 'meta charset="utf-8"><' + 'title>Export<' + '/title>';
            var css = '<' + 'style>';
            css += '@page Section1 { size: 21.0cm 29.7cm; margin: 2.0cm 2.0cm 2.0cm 2.0cm; mso-header-margin: 35.4pt; mso-footer-margin: 35.4pt; mso-paper-source: 0; }';
            css += 'div.Section1 { page: Section1; }';
            css += 'body { font-family: "Times New Roman", serif; font-size: 13pt; line-height: 1.3; }';
            css += '.title-main { text-align: center; color: #002060; font-weight: bold; font-size: 14pt; text-transform: uppercase; margin-bottom: 5px; }';
            css += '.title-sub { text-align: center; color: #002060; font-weight: bold; font-size: 14pt; text-transform: uppercase; margin-bottom: 20px; }';
            css += '.lv1 { font-weight: bold; color: #002060; font-size: 14pt; margin-top: 15px; margin-bottom: 5px; }';
            css += '.lv2 { font-weight: bold; color: #002060; font-size: 13pt; margin-left: 1.0cm; margin-bottom: 5px; }';
            css += '.lv3 { font-size: 13pt; margin-left: 2.0cm; margin-bottom: 5px; }';
            css += '.lv4 { font-size: 13pt; margin-left: 3.0cm; margin-bottom: 5px; }';
            css += '.footer-right { text-align: right; margin-right: 1.0cm; margin-top: 30px; }';
            css += 'table { border-collapse: collapse; width: 100%; font-size: 11pt; }';
            css += 'td, th { border: 1px solid black; padding: 5px; }';
            css += '<' + '/style>';
            
            var part3 = '<' + '/head><' + 'body><' + 'div class="Section1">';
            var mhtmlBody = "";
            const today = new Date();
            const dateStr = "Ninh Ki·ªÅu, ng√†y " + today.getDate() + " th√°ng " + (today.getMonth() + 1) + " nƒÉm " + today.getFullYear();

            if (type === 'ASSIGN') {
                mhtmlBody += "<p class='title-main'>B√ÅO C√ÅO T·ªîNG H·ª¢P PH√ÇN C√îNG</p>";
                mhtmlBody += "<p class='title-sub'>" + folderName.toUpperCase() + "</p>";
                mhtmlBody += "<p style='text-align:center; color:#002060; font-weight:bold;'>---</p>";

                let hierarchy = {};
                items.forEach(function(item) {
                    const sub = item.SubjectName;
                    const blk = item.BlockName;
                    const obj = item.ObjectName;
                    const teacher = item.UserName;
                    const doc = item.DocTypeName;

                    if (!hierarchy[sub]) hierarchy[sub] = {};
                    if (!hierarchy[sub][blk]) hierarchy[sub][blk] = {};
                    if (!hierarchy[sub][blk][obj]) hierarchy[sub][blk][obj] = {};
                    if (!hierarchy[sub][blk][obj][teacher]) hierarchy[sub][blk][obj][teacher] = new Set();
                    hierarchy[sub][blk][obj][teacher].add(doc);
                });

                let subIndex = 1;
                for (const subName in hierarchy) {
                    mhtmlBody += "<p class='lv1'>" + subIndex + "/. M√¥n: " + subName + "</p>";
                    let charCode = 97; 
                    for (const blkName in hierarchy[subName]) {
                        const charLabel = String.fromCharCode(charCode);
                        mhtmlBody += "<p class='lv2'>" + charLabel + "/. " + blkName + "</p>";
                        for (const objName in hierarchy[subName][blkName]) {
                            mhtmlBody += "<p class='lv3'>* " + objName + ":</p>";
                            for (const teacherName in hierarchy[subName][blkName][objName]) {
                                const docs = hierarchy[subName][blkName][objName][teacherName];
                                const docString = Array.from(docs).join(', ');
                                mhtmlBody += "<p class='lv4'>- " + teacherName + " &nbsp;&nbsp;&nbsp; <i>(" + docString + ")</i></p>";
                            }
                        }
                        charCode++;
                    }
                    subIndex++;
                }

                mhtmlBody += "<div class='footer-right'>";
                mhtmlBody += "<p style='font-style:italic; margin-bottom:5px;'>" + dateStr + "</p>";
                mhtmlBody += "<p style='font-weight:bold; text-transform:uppercase;'>L·∫¨P B√ÅO C√ÅO</p>";
                mhtmlBody += "</div>";

            } else {
                mhtmlBody += "<h2 style='text-align:center; font-family:Times New Roman; color:#00b09b; text-transform:uppercase;'>T·ªîNG H·ª¢P K·∫æT QU·∫¢ N·ªòP H·ªí S∆†</h2>";
                mhtmlBody += "<p style='text-align:center; margin-bottom:20px;'><strong>K·ª≥ ki·ªÉm tra:</strong> " + folderName + "</p>";
                mhtmlBody += "<table><thead><tr style='background-color:#f2f2f2; font-weight:bold;'>";
                mhtmlBody += "<th style='width:40px;'>STT</th><th>M√¥n h·ªçc</th><th>Kh·ªëi</th><th>ƒê·ªëi t∆∞·ª£ng</th><th>N·ªôi dung h·ªì s∆°</th><th>Gi√°o vi√™n</th><th>Tr·∫°ng th√°i</th><th>Th·ªùi gian</th><th>Link File</th>";
                mhtmlBody += "</tr></thead><tbody>";

                items.forEach(function(item, index) {
                    const statusText = item.isUploaded ? "ƒê√£ n·ªôp" : "Ch∆∞a n·ªôp";
                    const statusColor = item.isUploaded ? "#008000" : "#ff0000";
                    const time = item.isUploaded ? formatDateTimeFull(item.TimeUpdate) : "";
                    const link = item.isUploaded ? "https://drive.google.com/uc?export=download&id=" + item.FileID : "";
                    const linkHtml = link ? "<a href='" + link + "' target='_blank'>Xem</a>" : "";

                    mhtmlBody += "<tr>";
                    mhtmlBody += "<td style='text-align:center;'>" + (index + 1) + "</td>";
                    mhtmlBody += "<td>" + item.SubjectName + "</td>";
                    mhtmlBody += "<td style='text-align:center;'>" + item.BlockName + "</td>";
                    mhtmlBody += "<td>" + item.ObjectName + "</td>";
                    mhtmlBody += "<td>" + item.DocTypeName + "</td>";
                    mhtmlBody += "<td>" + item.UserName + "<br><i style='font-size:9pt; color:#666;'>(" + (item.AccountEmail || "") + ")</i></td>";
                    mhtmlBody += "<td style='color:" + statusColor + "; font-weight:bold; text-align:center;'>" + statusText + "</td>";
                    mhtmlBody += "<td style='text-align:center;'>" + time + "</td>";
                    mhtmlBody += "<td style='text-align:center;'>" + linkHtml + "</td>";
                    mhtmlBody += "</tr>";
                });

                mhtmlBody += "</tbody></table>";
                mhtmlBody += "<br><p style='text-align:right; font-family:Times New Roman; font-style:italic;'>" + dateStr + "</p>";
            }

            var partEnd = "<" + "/div><" + "/body><" + "/html>";
            var finalContent = part1 + part2 + css + part3 + mhtmlBody + partEnd;

            const blob = new Blob(['\uFEFF', finalContent], { type: 'application/msword' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const timeStamp = new Date().toISOString().slice(0,10);
            a.download = "BaoCao_" + type + "_" + folderName + "_" + timeStamp + ".doc";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // --- RENDER TABLE (Th√™m tham s·ªë showUserCol ƒë·ªÉ ·∫©n/hi·ªán c·ªôt Gi√°o Vi√™n) ---
        function renderTable(items, isAdmin, showUserCol) {
            const wrapper = document.createElement('div');
            wrapper.className = 'table-responsive';

            items.sort((a, b) => {
                const subDiff = a.SubjectName.localeCompare(b.SubjectName);
                if (subDiff !== 0) return subDiff;
                const blkDiff = a.BlockName.localeCompare(b.BlockName);
                if (blkDiff !== 0) return blkDiff;
                const objDiff = a.ObjectName.localeCompare(b.ObjectName);
                if (objDiff !== 0) return objDiff;
                return a.DocTypeID - b.DocTypeID;
            });

            let tableHeader = `
                <thead>
                    <tr>
                        <th style="width: 40px;">#</th>
                        <th>M√¥n</th>
                        <th>Kh·ªëi</th>
                        <th>ƒê·ªëi t∆∞·ª£ng</th>
                        <th>File</th>
                        ${showUserCol ? '<th>Gi√°o vi√™n</th>' : ''}
                        <th>Tr·∫°ng th√°i</th>
                        <th style="width: 150px; text-align:right;">Thao t√°c</th>
                    </tr>
                </thead>
            `;

            let tableBody = '<tbody>';
            let prevSubject = null, prevBlock = null, prevObject = null;

            items.forEach((item, index) => {
                let showSubject = false, showBlock = false, showObject = false;
                if (item.SubjectName !== prevSubject) { showSubject = true; showBlock = true; showObject = true; }
                else if (item.BlockName !== prevBlock) { showBlock = true; showObject = true; }
                else if (item.ObjectName !== prevObject) { showObject = true; }

                prevSubject = item.SubjectName; prevBlock = item.BlockName; prevObject = item.ObjectName;

                const subCell = showSubject ? `<span class="table-badge badge-subject">${item.SubjectName}</span>` : '';
                const blkCell = showBlock ? `<span class="table-badge badge-block">${item.BlockName}</span>` : '';
                const objCell = showObject ? `<span class="table-badge badge-object">${item.ObjectName}</span>` : '';

                let isExpired = false;
                if (item.Deadline) {
                    const dl = new Date(item.Deadline); dl.setHours(23,59,59);
                    if (new Date() > dl) isExpired = true;
                }
                const isUploaded = item.isUploaded;
                let statusHtml = isUploaded ? `<span style="color:#00b09b;">‚úî ${formatDateTimeFull(item.TimeUpdate)}</span>` : `<span style="color:#e74c3c;">‚è≥ Ch∆∞a n·ªôp</span>`;

                let actionBtns = '';
                const downloadBtn = isUploaded ? `<button class="btn-icon download" title="T·∫£i v·ªÅ" onclick="downloadFile('${item.FileID}', '${item.ProfileID}')">üì•</button>` : '';

                if (item.RoleContext === 'admin') {
                    actionBtns += downloadBtn;
                    if (isUploaded) actionBtns += `<button class="btn-icon delete-file" title="X√≥a file" onclick="adminDeleteFile('${item.ProfileID}')">üóë</button>`;
                    actionBtns += `<button class="btn-icon delete-row" title="X√≥a d√≤ng" onclick="adminDeleteRow('${item.ProfileID}')">‚úï</button>`;
                } 
                else if (item.RoleContext === 'uploader') {
                    if (isExpired) {
                        actionBtns = isUploaded ? `${downloadBtn} <span class="status-expired">üîí</span>` : `<span class="status-expired">H·∫øt h·∫°n</span>`;
                    } else {
                        if (isUploaded) actionBtns = `${downloadBtn} <button class="btn-icon edit" title="Thay th·∫ø" onclick="triggerDirectUpload('${item.ProfileID}')">‚úé</button>`;
                        else actionBtns = `<button class="btn-icon upload" title="N·ªôp file" onclick="triggerDirectUpload('${item.ProfileID}')">üì§</button>`;
                    }
                } 
                else if (item.RoleContext === 'previewer') {
                    actionBtns = isUploaded ? downloadBtn : `<span class="status-text-small" style="color:#aaa;">Ch∆∞a c√≥ file</span>`;
                }

                tableBody += `
                    <tr>
                        <td style="text-align:center; color:#ccc;">${index + 1}</td>
                        <td class="${showSubject?'':'cell-hidden'}">${subCell}</td>
                        <td class="${showBlock?'':'cell-hidden'}">${blkCell}</td>
                        <td class="${showObject?'':'cell-hidden'}">${objCell}</td>
                        <td><span>${item.DocTypeName}</span>${item.Note ? `<br><small class="text-muted">üìù ${item.Note}</small>` : ''}</td>
                        ${showUserCol ? `<td>üë§ ${item.UserName}</td>` : ''}
                        <td style="font-size:0.85rem;">${statusHtml}${item.Deadline ? `<div class="text-muted" style="font-size:0.75rem;">H·∫°n: ${formatDate(item.Deadline)}</div>` : ''}</td>
                        <td><div class="cell-actions">${actionBtns}</div></td>
                    </tr>
                `;
            });

            const table = document.createElement('table');
            table.className = 'data-table';
            table.innerHTML = tableHeader + tableBody + '</tbody>';
            wrapper.appendChild(table);
            return wrapper;
        }
    </script>
</body>
</html>
